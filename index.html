<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <!-- Combined meta viewport with additional scaling settings -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <title>Sunshine Kitchen - Recipe Management & Meal Planner</title>

    <!-- Tailwind CSS (v2) -->
    <link
      href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />

    <!-- Google Material Icons -->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />

    <!-- JSZip for zipping files and for .zip import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- For .xlsx import (SheetJS) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <!-- For CSV import (PapaParse) -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

    <!-- ORIGINAL + NEW STYLES MERGED -->
    <style>
      /* Modal transitions and skip link */
      .modal-enter { opacity: 0; transform: scale(0.95); }
      .modal-enter-active {
        opacity: 1;
        transform: scale(1);
        transition: opacity 300ms, transform 300ms;
      }
      .modal-exit { opacity: 1; transform: scale(1); }
      .modal-exit-active {
        opacity: 0;
        transform: scale(0.95);
        transition: opacity 300ms, transform 300ms;
      }
      .skip-link {
        position: absolute;
        top: -40px;
        left: 0;
        background: #1d4ed8;
        color: #fff;
        padding: 8px;
        z-index: 100;
        transition: top 0.3s;
      }
      .skip-link:focus {
        top: 0;
      }
      @media print {
        body * {
          visibility: hidden;
        }
        .printable,
        .printable * {
          visibility: visible;
        }
        .printable {
          position: absolute;
          left: 0;
          top: 0;
        }
      }
      .modal-container {
        width: 90vw;
        height: 90vw;
        max-width: 500px;
        max-height: 500px;
      }
      @media only screen and (max-width: 480px) {
        .modal-container {
          width: 95vw;
          max-height: 90vh;
        }
      }

      /* Reset & Base Styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      html,
      body {
        background-color: #111;
        color: #fff;
        height: 100%;
        overflow-x: hidden;
      }
      a {
        text-decoration: none;
        color: inherit;
        cursor: pointer;
      }
      ul,
      li {
        list-style: none;
      }
      button {
        cursor: pointer;
        border: none;
        background: none;
      }
      input,
      select,
      textarea {
        background-color: #222;
        border: 1px solid #444;
        color: #fff;
        padding: 0.5em;
        border-radius: 4px;
        font-size: 0.95em;
      }
      input:focus,
      select:focus,
      textarea:focus,
      button:focus {
        outline: none;
      }

      /* Light Mode Overrides */
      .light-mode {
        background-color: #f5f5f5;
        color: #111;
      }
      .light-mode header,
      .light-mode .header-links,
      .light-mode .mobile-nav {
        background-color: #eaeaea;
      }
      .light-mode .site-title {
        color: #111;
      }
      .light-mode .nine-dot-menu,
      .light-mode .hamburger .bar {
        background-color: #333 !important;
      }
      .light-mode .toggle-dark-mode {
        background-color: #ccc;
        color: #111;
      }
      .light-mode input,
      .light-mode select,
      .light-mode textarea {
        background-color: #fff;
        border: 1px solid #888;
        color: #111;
      }
      .light-mode .section-container,
      .light-mode .recipe-card,
      .light-mode .meal-plan-section,
      .light-mode .shopping-list-section {
        background-color: #fff;
        color: #111;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .light-mode nav a:hover,
      .light-mode .dropdown-menu a:hover {
        background-color: #ddd;
        color: #111;
      }

      /* Header & Navigation */
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background-color: #222;
        padding: 0.5em 1em;
        position: sticky;
        top: 0;
        z-index: 999;
        border-bottom: 1px solid #333;
      }
      .site-title {
        font-size: 1.3em;
        font-weight: 600;
        color: #ffcc66;
        margin-right: 1em;
      }

      /* Mobile Nav */
      .mobile-nav {
        display: none;
        background-color: #222;
        position: absolute;
        top: 3.5em;
        right: 0;
        left: 0;
        padding: 1em;
        border-top: 1px solid #333;
      }
      .mobile-nav a {
        display: block;
        margin-bottom: 1em;
        color: #ccc;
        text-transform: uppercase;
        font-size: 0.95em;
      }
      .mobile-nav a:hover {
        color: #fff;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1em;
      }
      .section-container {
        background-color: #1c1c1c;
        border: 1px solid #333;
        border-radius: 6px;
        padding: 1em 1.5em;
        margin-bottom: 1.5em;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
      }
      .section-container h2 {
        margin-bottom: 0.5em;
        font-size: 1.2em;
        border-bottom: 1px solid #333;
        padding-bottom: 0.3em;
        color: #ffcc66;
      }
      .section-container p {
        margin-bottom: 1em;
        color: #ccc;
      }
      .search-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 1em;
        margin-bottom: 1.5em;
      }
      .search-bar input,
      .search-bar select {
        flex: 1;
        min-width: 200px;
      }
      .add-recipe-button {
        display: none;
        position: fixed;
        bottom: 1.5em;
        right: 1.5em;
        width: 3em;
        height: 3em;
        background-color: #ff5722;
        border-radius: 50%;
        font-size: 2em;
        color: #fff;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        z-index: 1000;
      }
      .recipe-card {
        background-color: #222;
        border: 1px solid #444;
        border-radius: 4px;
        padding: 1em;
        margin-bottom: 1em;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }
      .recipe-title {
        font-size: 1.2em;
        margin-bottom: 0.5em;
        font-weight: bold;
        color: #ffcc66;
      }
      .recipe-meta {
        font-size: 0.9em;
        margin-bottom: 0.5em;
        color: #bbb;
      }
      .recipe-img {
        max-width: 100%;
        height: auto;
        margin-bottom: 0.5em;
        display: none;
        border-radius: 4px;
        border: 1px solid #333;
      }
      .recipe-ingredients,
      .recipe-directions {
        margin-bottom: 0.5em;
      }
      .recipe-ingredients ul,
      .recipe-directions ol {
        margin-left: 1.2em;
        margin-top: 0.3em;
        padding-left: 1em;
      }
      .recipe-card button {
        background-color: #333;
        color: #fff;
        padding: 0.3em 0.6em;
        border-radius: 4px;
        margin-right: 0.3em;
        font-size: 0.8em;
        transition: background-color 0.3s, color 0.3s;
      }
      .recipe-card button:hover {
        background-color: #ffcc66;
        color: #111;
      }
      .meal-plan-section {
        background-color: #1c1c1c;
        border: 1px solid #333;
        border-radius: 4px;
        padding: 1em;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }
      .meal-plan-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1em;
      }
      .meal-plan-table th,
      .meal-plan-table td {
        border: 1px solid #444;
        padding: 0.5em;
        text-align: center;
        color: #ccc;
        font-size: 0.9em;
      }
      .meal-plan-day.highlight {
        background-color: #ff5722;
        color: #fff;
      }
      .shopping-list-section {
        background-color: #1c1c1c;
        border: 1px solid #333;
        border-radius: 4px;
        padding: 1em;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }
      .shopping-list-items {
        margin-bottom: 1em;
      }
      .shopping-list-items li {
        margin: 0.3em 0;
        cursor: pointer;
        padding: 0.2em 0.4em;
        border-radius: 4px;
        transition: background-color 0.2s;
      }
      .shopping-list-items li:hover {
        background-color: #333;
      }
      .shopping-list-section input[type="text"] {
        width: 70%;
        margin-right: 0.5em;
      }
      .shopping-list-section button {
        background-color: #ff5722;
        color: #fff;
        padding: 0.4em 0.8em;
        border-radius: 4px;
        font-size: 0.9em;
        transition: background-color 0.3s, color 0.3s;
      }
      .shopping-list-section button:hover {
        background-color: #ffcc66;
        color: #111;
      }
      @media (max-width: 768px) {
        .add-recipe-button {
          display: flex;
        }
        .section-container {
          margin-left: 0.2em;
          margin-right: 0.2em;
        }
      }
    </style>
  </head>
  <body class="bg-gray-900">
    <a href="#main-content" class="skip-link">Skip to Content</a>
    <script>
      (function checkBrowserCompatibility() {
        if (typeof window.Promise === "undefined" || typeof window.fetch === "undefined") {
          document.write('<script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"><\\/script>');
          document.write('<script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.js"><\\/script>');
        }
      })();
    </script>
    <div id="root"></div>
    <!-- React and ReactDOM (development builds) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- Babel for inline JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Added data-presets attribute to ensure React preset is used -->
    <script type="text/babel" data-presets="react">
      const { useState, useEffect, useRef } = React;

      // Utility: generate a simple unique ID
      function generateId() {
        return (
          Date.now().toString(36) +
          Math.floor(Math.random() * 999999).toString(36)
        );
      }

      function parseMarkdown(markdownContent) {
        const lines = markdownContent.split('\n');
        let frontmatter = {};
        let i = 0;
        if (lines[0].trim() === '---') {
          i++;
          while (i < lines.length && lines[i].trim() !== '---') {
            const line = lines[i].trim();
            const match = line.match(/^(.*?):\s*(.*)$/);
            if (match) {
              const key = match[1].trim();
              const value = match[2].replace(/\"/g, '').trim();
              frontmatter[key] = value;
            }
            i++;
          }
          i++;
        }
        const body = lines.slice(i).join('\n');
        return { frontmatter, body };
      }

      function parsePaprika(jsonString) {
        const data = JSON.parse(jsonString);
        return {
          title: data.name || '',
          dishType: '',
          mealType: '',
          cookbook: '',
          ingredients: (data.ingredients || '')
            .split('\n')
            .map((line) => {
              const parts = line.trim().split(' ');
              if (parts.length < 2)
                return { name: line.trim(), quantity: '', unit: '' };
              const quantityCandidate = parseFloat(parts[0]);
              if (!isNaN(quantityCandidate)) {
                const unitCandidate = parts[1];
                const nameCandidate = parts.slice(2).join(' ');
                return {
                  name: nameCandidate || '',
                  quantity: quantityCandidate.toString(),
                  unit: unitCandidate,
                };
              }
              return { name: line.trim(), quantity: '', unit: '' };
            }),
          prepTime: '',
          cookTime: '',
          directions: data.directions || '',
          rating: parseInt(data.rating || '0', 10),
          notes: data.description || '',
          temperature: { value: '', scale: 'F' },
        };
      }

      function rowToRecipe(rowObj) {
        return {
          title: rowObj.title || 'Untitled',
          dishType: rowObj.dishType || '',
          mealType: rowObj.mealType || '',
          cookbook: rowObj.cookbook || '',
          ingredients: (rowObj.ingredients || '')
            .split('\n')
            .map((line) => {
              const parts = line.trim().split(' ');
              if (parts.length < 2)
                return { name: line.trim(), quantity: '', unit: '' };
              const quantityCandidate = parseFloat(parts[0]);
              if (!isNaN(quantityCandidate)) {
                const unitCandidate = parts[1];
                const nameCandidate = parts.slice(2).join(' ');
                return {
                  name: nameCandidate || '',
                  quantity: quantityCandidate.toString(),
                  unit: unitCandidate,
                };
              }
              return { name: line.trim(), quantity: '', unit: '' };
            }),
          directions: rowObj.directions || '',
          rating: parseInt(rowObj.rating || '0', 10),
          notes: rowObj.notes || '',
          prepTime: rowObj.prepTime || '',
          cookTime: rowObj.cookTime || '',
          temperature: {
            value: rowObj.tempValue || '',
            scale: rowObj.tempScale || 'F',
          },
        };
      }

      function StarRating({ rating, setRating }) {
        const handleClick = (newRating) => setRating(newRating);
        return (
          <div className="flex items-center" role="radiogroup" aria-label="Star Rating">
            {[1, 2, 3, 4, 5].map((star) => (
              <button
                key={star}
                type="button"
                onClick={() => handleClick(star)}
                className="text-2xl focus:outline-none"
                role="radio"
                aria-checked={star === rating}
                aria-label={`${star} star${star !== 1 ? 's' : ''}`}
              >
                {star <= rating ? '★' : '☆'}
              </button>
            ))}
          </div>
        );
      }

      function IngredientRow({
        ingredient,
        index,
        handleIngredientChange,
        removeIngredientRow,
        masterIngredients,
      }) {
        const units = [
          'tsp',
          'tbsp',
          'cup',
          'oz',
          'lb',
          'ml',
          'l',
          'g',
          'kg',
        ];
        return (
          <div className="flex flex-col md:flex-row md:space-x-2 mb-2">
            <label className="sr-only" htmlFor={`ingredient-select-${index}`}>
              Select Ingredient
            </label>
            <select
              id={`ingredient-select-${index}`}
              value={ingredient.name || ''}
              onChange={(e) =>
                handleIngredientChange(index, 'name', e.target.value)
              }
              className="w-full md:w-1/3 p-2 border rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-teal-400 mb-2 md:mb-0"
            >
              <option value="">-- Master Ingredient List --</option>
              {masterIngredients.map((item, i) => (
                <option key={i} value={item}>
                  {item}
                </option>
              ))}
            </select>
            <label className="sr-only" htmlFor={`ingredient-name-${index}`}>
              Ingredient Name
            </label>
            <input
              id={`ingredient-name-${index}`}
              type="text"
              placeholder="Ingredient Name"
              value={ingredient.name}
              onChange={(e) =>
                handleIngredientChange(index, 'name', e.target.value)
              }
              className="w-full md:w-1/3 p-2 border rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-teal-400 mb-2 md:mb-0"
            />
            <label className="sr-only" htmlFor={`ingredient-qty-${index}`}>
              Quantity
            </label>
            <input
              id={`ingredient-qty-${index}`}
              type="number"
              step="any"
              placeholder="Quantity"
              value={ingredient.quantity}
              onChange={(e) =>
                handleIngredientChange(index, 'quantity', e.target.value)
              }
              className="w-full md:w-1/4 p-2 border rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-teal-400 mb-2 md:mb-0"
            />
            <label className="sr-only" htmlFor={`ingredient-unit-${index}`}>
              Unit
            </label>
            <select
              id={`ingredient-unit-${index}`}
              value={ingredient.unit}
              onChange={(e) =>
                handleIngredientChange(index, 'unit', e.target.value)
              }
              className="w-full md:w-1/4 p-2 border rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-teal-400 mb-2 md:mb-0"
            >
              <option value="">Unit</option>
              {units.map((u) => (
                <option key={u} value={u}>
                  {u}
                </option>
              ))}
            </select>
            <button
              type="button"
              onClick={() => removeIngredientRow(index)}
              className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded"
              aria-label={`Remove ingredient row ${index + 1}`}
            >
              X
            </button>
          </div>
        );
      }

      function RecipeCard({ recipe, index, onDeleteRecipe, onEditRecipe }) {
        const [menuOpen, setMenuOpen] = useState(false);

        const handleDelete = () => {
          if (
            confirm(`Are you sure you want to delete the recipe "${recipe.title}"?`)
          ) {
            onDeleteRecipe(recipe);
          }
        };

        const handlePrint = () => {
          const printWindow = window.open('', '', 'height=600,width=800');
          printWindow.document.write('<html><head><title>Print Recipe</title>');
          printWindow.document.write(
            '<style>@media print { body { margin: 20px; } } body { font-family: Arial, sans-serif; } .card { border: 1px solid #ccc; padding: 20px; } img { max-width: 100%; height: auto; }</style>'
          );
          printWindow.document.write('</head><body>');
          printWindow.document.write('<div class="card printable">');
          printWindow.document.write('<h1>' + (recipe.title || 'Untitled Recipe') + '</h1>');
          if (recipe.image) {
            printWindow.document.write('<img src="' + recipe.image + '" alt="Recipe Image" class="mb-4" />');
          }
          printWindow.document.write('<p><strong>Dish Type:</strong> ' + (recipe.dishType || 'N/A') + '</p>');
          printWindow.document.write('<p><strong>Meal Type:</strong> ' + (recipe.mealType || 'N/A') + '</p>');
          printWindow.document.write('<p><strong>Cookbook:</strong> ' + (recipe.cookbook || 'N/A') + '</p>');
          printWindow.document.write('<p><strong>Prep Time:</strong> ' + (recipe.prepTime || 'N/A') + '</p>');
          printWindow.document.write('<p><strong>Cook Time:</strong> ' + (recipe.cookTime || 'N/A') + '</p>');
          if (recipe.temperature && recipe.temperature.value) {
            printWindow.document.write('<p><strong>Temp:</strong> ' +
              recipe.temperature.value + '°' + recipe.temperature.scale + '</p>');
          }
          printWindow.document.write('<p><strong>Rating:</strong> ' +
            '★'.repeat(recipe.rating) + '☆'.repeat(5 - recipe.rating) + '</p>');
          if (recipe.ingredients && recipe.ingredients.length > 0) {
            printWindow.document.write('<h3>Ingredients</h3><ul>');
            recipe.ingredients.forEach((ing) => {
              printWindow.document.write('<li>' +
                (ing.quantity ? ing.quantity + ' ' : '') +
                (ing.unit ? ing.unit + ' ' : '') +
                ing.name + '</li>');
            });
            printWindow.document.write('</ul>');
          }
          if (recipe.directions) {
            printWindow.document.write('<h3>Directions</h3><p>' +
              recipe.directions.replace(/\n/g, '<br>') + '</p>');
          }
          printWindow.document.write('</div></body></html>');
          printWindow.document.close();
          printWindow.focus();
          printWindow.print();
        };

        return (
          <div
            className="border rounded-lg p-4 shadow-md bg-gray-800 text-white hover:shadow-lg transition-shadow duration-300 relative"
            role="article"
            aria-label={`Recipe: ${recipe.title || 'Untitled'}`}
          >
            <div className="relative w-full mb-4" style={{ paddingTop: '60%', overflow: 'hidden' }}>
              {recipe.image ? (
                <img
                  src={recipe.image}
                  alt={recipe.title || 'Recipe Image'}
                  className="absolute top-0 left-0 w-full h-full object-cover rounded-t-lg"
                />
              ) : (
                <div className="absolute top-0 left-0 w-full h-full border-2 border-dashed border-gray-600 flex items-center justify-center text-white rounded-t-lg">
                  <span>No Image</span>
                </div>
              )}
            </div>
            <h3 className="text-xl font-bold mb-2 text-white" tabIndex="0">
              {recipe.title || 'Untitled Recipe'}
            </h3>
            <p className="mb-1 text-white"><strong>Dish Type:</strong> {recipe.dishType || 'N/A'}</p>
            <p className="mb-1 text-white"><strong>Meal Type:</strong> {recipe.mealType || 'N/A'}</p>
            <p className="mb-1 text-white"><strong>Cookbook:</strong> {recipe.cookbook || 'N/A'}</p>
            <p className="mb-1 text-white"><strong>Prep Time:</strong> {recipe.prepTime || 'N/A'}</p>
            <p className="mb-1 text-white"><strong>Cook Time:</strong> {recipe.cookTime || 'N/A'}</p>
            {recipe.temperature && recipe.temperature.value && (
              <p className="mb-1 text-white"><strong>Temp:</strong> {recipe.temperature.value}°{recipe.temperature.scale}</p>
            )}
            {recipe.rating > 0 && (
              <p className="mb-1 text-white" aria-label={`Recipe rating: ${recipe.rating}`}>
                <strong>Rating:</strong> {`${'★'.repeat(recipe.rating)}${'☆'.repeat(5 - recipe.rating)}`}
              </p>
            )}
            {recipe.ingredients && recipe.ingredients.length > 0 && (
              <div className="mt-2">
                <strong className="text-white">Ingredients:</strong>
                <ul className="list-disc list-inside mt-1">
                  {recipe.ingredients.map((ing, i) => (
                    <li key={i} className="text-white">
                      {(ing.quantity ? ing.quantity + ' ' : '') +
                        (ing.unit ? ing.unit + ' ' : '') +
                        ing.name}
                    </li>
                  ))}
                </ul>
              </div>
            )}
            {recipe.directions && (
              <div className="mt-2">
                <strong className="text-white">Directions:</strong>
                <p className="whitespace-pre-wrap mt-1 text-white">
                  {recipe.directions}
                </p>
              </div>
            )}
            <div className="absolute bottom-2 right-2">
              <button
                onClick={() => setMenuOpen(!menuOpen)}
                className="text-white focus:outline-none"
                aria-label="Options"
              >
                <span className="material-icons">more_vert</span>
              </button>
              {menuOpen && (
                <div className="absolute right-0 bottom-full mb-2 w-32 bg-gray-800 border border-gray-700 rounded shadow-lg z-10">
                  <button
                    onClick={() => {
                      setMenuOpen(false);
                      onEditRecipe(index, recipe);
                    }}
                    className="block w-full text-left px-4 py-2 hover:bg-gray-700"
                    aria-label={`Edit recipe ${recipe.title}`}
                  >
                    Edit
                  </button>
                  <button
                    onClick={() => {
                      setMenuOpen(false);
                      handlePrint();
                    }}
                    className="block w-full text-left px-4 py-2 hover:bg-gray-700"
                    aria-label={`Print recipe ${recipe.title}`}
                  >
                    Print
                  </button>
                  <button
                    onClick={() => {
                      setMenuOpen(false);
                      handleDelete();
                    }}
                    className="block w-full text-left px-4 py-2 hover:bg-gray-700"
                    aria-label={`Delete recipe ${recipe.title}`}
                  >
                    Delete
                  </button>
                </div>
              )}
            </div>
          </div>
        );
      }

      function MealPlanMealSelector({ day, mealType, value, onChange, recipes, hideLabel }) {
        const [searchQuery, setSearchQuery] = useState('');
        const [isFocused, setIsFocused] = useState(false);

        const selectedRecipe = recipes.find((r) => r.id === value) || null;
        const inputValue = searchQuery !== '' ? searchQuery : selectedRecipe ? selectedRecipe.title : '';
        const suggestions = recipes.filter(
          (recipe) =>
            recipe.mealType === mealType &&
            recipe.title.toLowerCase().startsWith(searchQuery.toLowerCase())
        );

        const handleSelect = (recipe) => {
          onChange(recipe.id);
          setSearchQuery('');
        };

        return (
          <div className="relative">
            {!hideLabel && <label className="block text-white mb-1">{mealType}</label>}
            <input
              type="text"
              placeholder={hideLabel ? `Search ${mealType}...` : `Search ${mealType} meals...`}
              value={inputValue}
              onChange={(e) => {
                setSearchQuery(e.target.value);
                onChange('');
              }}
              onFocus={() => setIsFocused(true)}
              onBlur={() => { setTimeout(() => setIsFocused(false), 200); }}
              className="w-full p-2 border rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"
            />
            {isFocused && inputValue !== '' && suggestions.length > 0 && (
              <ul className="absolute z-10 w-full bg-gray-700 border border-gray-600 rounded mt-1 max-h-40 overflow-y-auto">
                {suggestions.map((recipe, index) => (
                  <li
                    key={index}
                    onMouseDown={() => handleSelect(recipe)}
                    className="p-2 hover:bg-teal-500 cursor-pointer text-white"
                  >
                    {recipe.title}
                  </li>
                ))}
              </ul>
            )}
          </div>
        );
      }

      function AutocompleteSearch({ searchQuery, setSearchQuery, recipes, onFocus }) {
        const [isFocused, setIsFocused] = useState(false);
        const suggestions = recipes.filter((recipe) =>
          recipe.title.toLowerCase().includes(searchQuery.toLowerCase())
        );

        return (
          <div className="relative">
            <input
              type="text"
              placeholder="Search recipes..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              onFocus={() => { setIsFocused(true); onFocus && onFocus(); }}
              onBlur={() => setTimeout(() => setIsFocused(false), 200)}
              className="border p-2 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"
              aria-label="Search recipes"
            />
            {isFocused && searchQuery !== '' && suggestions.length > 0 && (
              <ul className="absolute z-10 w-full bg-gray-700 border border-gray-600 rounded mt-1 max-h-40 overflow-y-auto">
                {suggestions.map((recipe, index) => (
                  <li
                    key={index}
                    onMouseDown={() => setSearchQuery(recipe.title)}
                    className="p-2 hover:bg-teal-500 cursor-pointer text-white"
                  >
                    {recipe.title}
                  </li>
                ))}
              </ul>
            )}
          </div>
        );
      }

      function MealPlanCalendar({ mealPlan, recipes, mealTypes, updateMealPlan }) {
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const currentDay = new Date().toLocaleString('en-US', { weekday: 'long' });

        return (
          <div className="overflow-auto">
            <table className="min-w-full text-white">
              <thead>
                <tr>
                  <th className="px-4 py-2 border border-gray-600 bg-gray-800">Meal Type / Day</th>
                  {days.map((day) => (
                    <th key={day} className={`px-4 py-2 border border-gray-600 ${day === currentDay ? 'bg-gray-600' : 'bg-gray-800'}`}>
                      {day}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {mealTypes.map((mealType) => (
                  <tr key={mealType}>
                    <td className="px-4 py-2 border border-gray-600 bg-gray-700 font-bold">{mealType}</td>
                    {days.map((day) => (
                      <td key={day} className={`px-4 py-2 border border-gray-600 ${day === currentDay ? 'bg-gray-600' : ''}`}>
                        <MealPlanMealSelector
                          day={day}
                          mealType={mealType}
                          value={mealPlan[day][mealType]}
                          onChange={(newId) => updateMealPlan(day, mealType, newId)}
                          recipes={recipes}
                          hideLabel={true}
                        />
                      </td>
                    ))}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        );
      }

      function CreateCookbookModal({ onCreate, onClose }) {
        const [newName, setNewName] = useState('');
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
            <div className="bg-gray-800 p-4 rounded">
              <h2 className="text-white text-xl mb-4">Create Cookbook</h2>
              <input
                type="text"
                placeholder="Cookbook Name"
                value={newName}
                onChange={(e) => setNewName(e.target.value)}
                className="p-2 border rounded bg-gray-700 text-white"
              />
              <div className="mt-4 flex justify-end">
                <button
                  onClick={() => { onCreate(newName); setNewName(''); }}
                  className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded mr-2"
                >
                  Create
                </button>
                <button onClick={onClose} className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                  Cancel
                </button>
              </div>
            </div>
          </div>
        );
      }

      function EditCookbookModal({ cookbook, onUpdate, onClose }) {
        const [newTitle, setNewTitle] = useState(cookbook.title);
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
            <div className="bg-gray-800 p-4 rounded">
              <h2 className="text-white text-xl mb-4">Edit Cookbook</h2>
              <input
                type="text"
                value={newTitle}
                onChange={(e) => setNewTitle(e.target.value)}
                className="p-2 border rounded bg-gray-700 text-white"
              />
              <div className="mt-4 flex justify-end">
                <button
                  onClick={() => { onUpdate({ ...cookbook, title: newTitle }); }}
                  className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded mr-2"
                >
                  Update
                </button>
                <button onClick={onClose} className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                  Cancel
                </button>
              </div>
            </div>
          </div>
        );
      }

      // Updated CategorizedMasterIngredientsList to handle searching, selecting, and filtering recipes
      function CategorizedMasterIngredientsList({
        masterIngredients,
        setMasterIngredients,
        selectedIngredients,
        setSelectedIngredients,
        filterRecipes
      }) {
        // Mapping of ingredient names to categories
        const ingredientCategories = {
          "Salt": "Spices & Seasonings",
          "Pepper": "Spices & Seasonings",
          "Garlic": "Spices & Seasonings",
          "Onion": "Spices & Seasonings",
          "Olive Oil": "Oils & Fats",
          "Butter": "Oils & Fats",
          "Sugar": "Baking & Sweeteners",
          "Flour": "Baking & Sweeteners",
          "Eggs": "Dairy & Eggs",
          "Milk": "Dairy & Eggs",
          "Baking Powder": "Baking & Sweeteners",
          "Baking Soda": "Baking & Sweeteners",
          "Vanilla Extract": "Baking & Sweeteners",
          "Chicken Breast": "Proteins & Meats",
          "Ground Beef": "Proteins & Meats",
          "Pork Chops": "Proteins & Meats",
          "Tomatoes": "Vegetables",
          "Potatoes": "Vegetables",
          "Carrots": "Vegetables",
          "Celery": "Vegetables",
          "Lettuce": "Vegetables",
          "Bell Peppers": "Vegetables",
          "Cheddar Cheese": "Dairy & Eggs",
          "Mozzarella Cheese": "Dairy & Eggs",
          "Parmesan Cheese": "Dairy & Eggs",
          "Cream Cheese": "Dairy & Eggs",
          "Yogurt": "Dairy & Eggs",
          "Mayonnaise": "Condiments & Sauces",
          "Ketchup": "Condiments & Sauces",
          "Mustard": "Condiments & Sauces",
          "Soy Sauce": "Condiments & Sauces",
          "Worcestershire Sauce": "Condiments & Sauces",
          "Hot Sauce": "Condiments & Sauces",
          "Vinegar (White)": "Condiments & Sauces",
          "Apple Cider Vinegar": "Condiments & Sauces",
          "Balsamic Vinegar": "Condiments & Sauces",
          "Rice": "Grains & Pasta",
          "Pasta (Spaghetti)": "Grains & Pasta",
          "Pasta (Penne)": "Grains & Pasta",
          "Beans (Black)": "Legumes & Beans",
          "Beans (Pinto)": "Legumes & Beans",
          "Beans (Kidney)": "Legumes & Beans",
          "Lentils": "Legumes & Beans",
          "Bread": "Grains & Pasta",
          "Tortillas": "Grains & Pasta",
          "Cornstarch": "Others",
          "Oats": "Grains & Pasta",
          "Peanut Butter": "Others",
          "Jelly (Grape)": "Others",
          "Honey": "Baking & Sweeteners",
          "Syrup (Maple)": "Baking & Sweeteners",
          "Chocolate Chips": "Baking & Sweeteners",
          "Cocoa Powder": "Baking & Sweeteners",
          "Chicken Broth": "Broths & Stocks",
          "Beef Broth": "Broths & Stocks",
          "Fish Sauce": "Condiments & Sauces",
          "Sesame Oil": "Oils & Fats",
          "Canola Oil": "Oils & Fats",
          "Vegetable Oil": "Oils & Fats",
          "Coconut Oil": "Oils & Fats",
          "Coconut Milk": "Others",
          "Lemon": "Fruits",
          "Lime": "Fruits",
          "Cumin": "Spices & Seasonings",
          "Paprika": "Spices & Seasonings",
          "Chili Powder": "Spices & Seasonings",
          "Oregano": "Spices & Seasonings",
          "Basil": "Spices & Seasonings",
          "Rosemary": "Spices & Seasonings",
          "Thyme": "Spices & Seasonings",
          "Cinnamon": "Baking & Sweeteners",
          "Nutmeg": "Baking & Sweeteners",
          "Ginger": "Spices & Seasonings",
          "Turmeric": "Spices & Seasonings",
          "Cayenne Pepper": "Spices & Seasonings",
          "Red Pepper Flakes": "Spices & Seasonings",
          "Bay Leaves": "Spices & Seasonings",
          "Parsley": "Spices & Seasonings",
          "Cilantro": "Spices & Seasonings",
          "Green Onions": "Spices & Seasonings",
          "Corn": "Vegetables",
          "Peas": "Vegetables",
          "Green Beans": "Vegetables",
          "Broccoli": "Vegetables",
          "Cauliflower": "Vegetables",
          "Spinach": "Vegetables",
          "Mushrooms": "Vegetables",
          "Zucchini": "Vegetables",
          "Squash": "Vegetables",
          "Eggplant": "Vegetables",
          "Apples": "Fruits",
          "Bananas": "Fruits",
          "Strawberries": "Fruits",
          "Blueberries": "Fruits",
          "Raspberries": "Fruits",
          "Grapes": "Fruits",
          "Orange": "Fruits",
          "Pineapple": "Fruits",
          "Brown Sugar": "Baking & Sweeteners",
          "Powdered Sugar": "Baking & Sweeteners",
          "Cream": "Dairy & Eggs",
          "Half & Half": "Dairy & Eggs",
          "Bacon": "Proteins & Meats",
          "Ham": "Proteins & Meats"
        };

        const [searchQuery, setSearchQuery] = useState("");

        const groupedIngredients = masterIngredients.reduce((acc, ingredient) => {
          // Filter by search query
          if (searchQuery && !ingredient.toLowerCase().includes(searchQuery.toLowerCase())) {
            return acc;
          }
          const category = ingredientCategories[ingredient] || "Uncategorized";
          if (!acc[category]) acc[category] = [];
          acc[category].push(ingredient);
          return acc;
        }, {});

        const sortedCategories = Object.keys(groupedIngredients).sort();

        // Handles toggling an ingredient within the selectedIngredients array
        const handleToggleIngredient = (ingredient) => {
          setSelectedIngredients((prev) =>
            prev.includes(ingredient)
              ? prev.filter((item) => item !== ingredient)
              : [...prev, ingredient]
          );
        };

        return (
          <div id="categorized-master-ingredients" className="p-4 bg-gray-800 rounded shadow">
            <h2 className="text-2xl font-bold text-white mb-4">Master Ingredients</h2>
            <input
              type="text"
              placeholder="Search ingredients..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="p-2 border rounded bg-gray-700 text-white mb-4 w-full"
            />

            {sortedCategories.map((category) => (
              <div key={category} className="mb-6">
                <h3 className="text-xl font-semibold text-white mb-2">{category}</h3>
                <ul className="mb-4 divide-y divide-gray-600">
                  {groupedIngredients[category].map((ingredient, index) => (
                    <li key={index} className="flex justify-between items-center py-2 px-4">
                      <div className="flex items-center">
                        <input
                          type="checkbox"
                          checked={selectedIngredients.includes(ingredient)}
                          onChange={() => handleToggleIngredient(ingredient)}
                          className="mr-2"
                        />
                        <span className="text-white">{ingredient}</span>
                      </div>
                      <button
                        className="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm"
                        onClick={() => {
                          const updated = masterIngredients.filter((item) => item !== ingredient);
                          setMasterIngredients(updated);
                        }}
                      >
                        Remove
                      </button>
                    </li>
                  ))}
                </ul>
              </div>
            ))}

            <div className="flex items-center mt-4">
              <input
                type="text"
                placeholder="New ingredient name"
                className="p-2 border rounded bg-gray-700 text-white mr-2 w-full"
                id="new-ingredient-name"
              />
              <button
                className="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm"
                onClick={() => {
                  const inputElem = document.getElementById("new-ingredient-name");
                  if (inputElem) {
                    const newIngredient = inputElem.value.trim();
                    if (newIngredient && !masterIngredients.includes(newIngredient)) {
                      setMasterIngredients([...masterIngredients, newIngredient]);
                    }
                    inputElem.value = "";
                  }
                }}
              >
                Add
              </button>
            </div>

            <button
              onClick={filterRecipes}
              className="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded"
            >
              Filter Recipes
            </button>
          </div>
        );
      }

      // Default top 100 ingredients
      const defaultMasterIngredients = [
        "Salt","Pepper","Garlic","Onion","Olive Oil","Butter","Sugar","Flour","Eggs","Milk",
        "Baking Powder","Baking Soda","Vanilla Extract","Chicken Breast","Ground Beef","Pork Chops","Tomatoes","Potatoes","Carrots","Celery",
        "Lettuce","Bell Peppers","Cheddar Cheese","Mozzarella Cheese","Parmesan Cheese","Cream Cheese","Yogurt","Mayonnaise","Ketchup","Mustard",
        "Soy Sauce","Worcestershire Sauce","Hot Sauce","Vinegar (White)","Apple Cider Vinegar","Balsamic Vinegar","Rice","Pasta (Spaghetti)","Pasta (Penne)","Beans (Black)",
        "Beans (Pinto)","Beans (Kidney)","Lentils","Bread","Tortillas","Cornstarch","Oats","Peanut Butter","Jelly (Grape)","Honey",
        "Syrup (Maple)","Chocolate Chips","Cocoa Powder","Chicken Broth","Beef Broth","Fish Sauce","Sesame Oil","Canola Oil","Vegetable Oil","Coconut Oil",
        "Coconut Milk","Lemon","Lime","Cumin","Paprika","Chili Powder","Oregano","Basil","Rosemary","Thyme",
        "Cinnamon","Nutmeg","Ginger","Turmeric","Cayenne Pepper","Red Pepper Flakes","Bay Leaves","Parsley","Cilantro","Green Onions",
        "Corn","Peas","Green Beans","Broccoli","Cauliflower","Spinach","Mushrooms","Zucchini","Squash","Eggplant",
        "Apples","Bananas","Strawberries","Blueberries","Raspberries","Grapes","Orange","Pineapple","Brown Sugar","Powdered Sugar",
        "Cream","Half & Half","Bacon","Ham"
      ];

      function RecipeSaver() {
        const mealTypes = ['Breakfast', 'Lunch', 'Dinner', 'Snack', 'Party'];
        const dishTypes = [
          'Pasta', 'Bread', 'Soup', 'Salad', 'Dessert',
          'Meat', 'Seafood', 'Vegetarian', 'Vegan'
        ];
        // State for master ingredients
        const [masterIngredients, setMasterIngredients] = useState(() => {
          const saved = localStorage.getItem('masterIngredients');
          return saved ? JSON.parse(saved) : defaultMasterIngredients;
        });

        // NEW: Selected ingredients to filter recipes
        const [selectedIngredients, setSelectedIngredients] = useState([]);

        // NEW: Filtered recipes state
        const [filteredRecipes, setFilteredRecipes] = useState([]);

        const [recipes, setRecipes] = useState([]);
        const [cookbooks, setCookbooks] = useState([]);
        const [mealPlan, setMealPlan] = useState(() => {
          const days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
          const plan = {};
          days.forEach((day) => {
            plan[day] = {};
            mealTypes.forEach((type) => {
              plan[day][type] = '';
            });
          });
          return plan;
        });
        const [categoryImages, setCategoryImages] = useState({});
        const [url, setUrl] = useState('');
        const [fetchMethod, setFetchMethod] = useState('url');
        const [title, setTitle] = useState('');
        const [selectedDishType, setSelectedDishType] = useState('');
        const [selectedMealType, setSelectedMealType] = useState('');
        const [cookbook, setCookbook] = useState('');
        const [prepTime, setPrepTime] = useState('');
        const [cookTime, setCookTime] = useState('');
        const [temperatureValue, setTemperatureValue] = useState('');
        const [temperatureScale, setTemperatureScale] = useState('F');
        const [rating, setRating] = useState(0);
        const [notes, setNotes] = useState('');
        const [newImagePreview, setNewImagePreview] = useState('');
        const [directions, setDirections] = useState('');
        const [ingredients, setIngredients] = useState([]);
        const [activeTab, setActiveTab] = useState('categories');
        const [showModal, setShowModal] = useState(false);
        const [modalTab, setModalTab] = useState('General');
        const [loading, setLoading] = useState(false);
        const [editingIndex, setEditingIndex] = useState(null);
        const [selectedCookbook, setSelectedCookbook] = useState(null);
        const [selectedMealTime, setSelectedMealTime] = useState(null);
        const [mobileNavOpen, setMobileNavOpen] = useState(false);
        const [isNewCookbook, setIsNewCookbook] = useState(false);
        const [showCreateCookbookModal, setShowCreateCookbookModal] = useState(false);
        const [editCookbook, setEditCookbook] = useState(null);
        const [baseServings, setBaseServings] = useState('');
        const [desiredServings, setDesiredServings] = useState('');
        const [searchQuery, setSearchQuery] = useState('');
        const [filterDish, setFilterDish] = useState('');
        const [filterMeal, setFilterMeal] = useState('');
        const [showSearch, setShowSearch] = useState(false);
        const recipeImageInputRef = useRef(null);
        const [showImportModal, setShowImportModal] = useState(false);
        const [dotsMenuOpen, setDotsMenuOpen] = useState(false);

        // Export function: downloads recipes as JSON file
        const handleExportRecipes = () => {
          const dataStr = JSON.stringify(recipes, null, 2);
          const blob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "recipes.json";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        };

        // Import function: merge imported recipes with current recipes
        const handleImportRecipes = (importedRecipes) => {
          setRecipes(prev => [...prev, ...importedRecipes]);
        };

        useEffect(() => {
          const savedRecipes = localStorage.getItem('recipes');
          if (savedRecipes) setRecipes(JSON.parse(savedRecipes));
          const savedCookbooks = localStorage.getItem('cookbooks');
          if (savedCookbooks) setCookbooks(JSON.parse(savedCookbooks));
          const savedCategoryImages = localStorage.getItem('categoryImages');
          if (savedCategoryImages) setCategoryImages(JSON.parse(savedCategoryImages));
          const savedMealPlan = localStorage.getItem('mealPlan');
          if (savedMealPlan) setMealPlan(JSON.parse(savedMealPlan));
          document.documentElement.classList.add('dark');
        }, []);

        useEffect(() => { localStorage.setItem('recipes', JSON.stringify(recipes)); }, [recipes]);
        useEffect(() => { localStorage.setItem('cookbooks', JSON.stringify(cookbooks)); }, [cookbooks]);
        useEffect(() => { localStorage.setItem('categoryImages', JSON.stringify(categoryImages)); }, [categoryImages]);
        useEffect(() => { localStorage.setItem('mealPlan', JSON.stringify(mealPlan)); }, [mealPlan]);
        useEffect(() => { localStorage.setItem('masterIngredients', JSON.stringify(masterIngredients)); }, [masterIngredients]);

        const addIngredientRow = () => setIngredients(prev => [...prev, { name: '', quantity: '', unit: '' }]);
        const handleIngredientChange = (index, field, value) => {
          const updated = [...ingredients];
          updated[index][field] = value;
          setIngredients(updated);
        };
        const removeIngredientRow = (index) => setIngredients(ingredients.filter((_, i) => i !== index));
        const handleImageChange = (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onloadend = () => { setNewImagePreview(reader.result); };
            reader.readAsDataURL(file);
          }
        };
        const handleFetchRecipe = async () => {
          setLoading(true);
          try {
            let fetchedRecipe;
            if (url.trim().toLowerCase() === 'test') {
              fetchedRecipe = {
                id: generateId(),
                title: 'Test Recipe',
                dishType: 'Pasta',
                mealType: 'Dinner',
                cookbook: 'Test Cookbook',
                ingredients: [
                  { name: 'Ingredient 1', quantity: '2', unit: 'cup' },
                  { name: 'Ingredient 2', quantity: '1', unit: 'tbsp' },
                ],
                prepTime: '10 minutes',
                cookTime: '20 minutes',
                directions: '1. Do something.\n2. Do next step.',
                rating: 3,
                temperature: { value: '350', scale: 'F' },
                image: '',
                notes: '',
                baseServings: '',
              };
            } else {
              const response = await axios.post('/api/fetch-recipe', { url });
              fetchedRecipe = response.data;
              if (!fetchedRecipe.id) fetchedRecipe.id = generateId();
            }
            setTitle(fetchedRecipe.title || '');
            setSelectedDishType(fetchedRecipe.dishType || '');
            setSelectedMealType(fetchedRecipe.mealType || '');
            setCookbook(fetchedRecipe.cookbook || '');
            setIsNewCookbook(false);
            setIngredients(fetchedRecipe.ingredients || []);
            setPrepTime(fetchedRecipe.prepTime || '');
            setCookTime(fetchedRecipe.cookTime || '');
            setDirections(fetchedRecipe.directions || '');
            setRating(fetchedRecipe.rating || 0);
            setNotes(fetchedRecipe.notes || '');
            setTemperatureValue(fetchedRecipe.temperature?.value || '');
            setTemperatureScale(fetchedRecipe.temperature?.scale || 'F');
            setNewImagePreview(fetchedRecipe.image || '');
            setBaseServings(fetchedRecipe.baseServings || '');
          } catch (error) {
            console.error('Error fetching recipe', error);
            alert('An error occurred while fetching the recipe. Please try again.');
          } finally {
            setLoading(false);
          }
        };
        const handleScaleRecipe = () => {
          const base = parseFloat(baseServings);
          const desired = parseFloat(desiredServings);
          if (base > 0 && desired > 0) {
            const factor = desired / base;
            const newIngredients = ingredients.map((ing) => {
              let qty = parseFloat(ing.quantity);
              if (!isNaN(qty)) {
                qty = Math.round(qty * factor * 100) / 100;
              }
              return { ...ing, quantity: isNaN(qty) ? ing.quantity : qty.toString() };
            });
            setIngredients(newIngredients);
            setBaseServings(desired.toString());
            setDesiredServings('');
          }
        };
        // Called when user clicks the "Filter Recipes" button in the ingredients tab
        const filterRecipes = () => {
          const filtered = recipes.filter((recipe) =>
            selectedIngredients.every((selected) =>
              recipe.ingredients.some(
                (rIng) => rIng.name.toLowerCase() === selected.toLowerCase()
              )
            )
          );
          console.log("Filtered Recipes:", filtered);
          alert(`Filtered to ${filtered.length} recipe(s) based on selected ingredients.`);
          // NEW: store the filtered recipes in state
          setFilteredRecipes(filtered);
        };
        const handleAddRecipe = () => {
          let newRecipe;
          if (editingIndex !== null) {
            const oldId = recipes[editingIndex].id;
            newRecipe = {
              id: oldId,
              title,
              dishType: selectedDishType,
              mealType: selectedMealType,
              cookbook,
              prepTime,
              cookTime,
              directions,
              rating,
              notes,
              temperature: { value: temperatureValue, scale: temperatureScale },
              ingredients,
              image: newImagePreview,
              baseServings,
            };
            setRecipes(prev => prev.map((r, i) => (i === editingIndex ? newRecipe : r)));
          } else {
            newRecipe = {
              id: generateId(),
              title,
              dishType: selectedDishType,
              mealType: selectedMealType,
              cookbook,
              prepTime,
              cookTime,
              directions,
              rating,
              notes,
              temperature: { value: temperatureValue, scale: temperatureScale },
              ingredients,
              image: newImagePreview,
              baseServings,
            };
            setRecipes(prev => [...prev, newRecipe]);
          }
          if (cookbook && !cookbooks.find(cb => cb.title === cookbook)) {
            setCookbooks(prev => [...prev, { title: cookbook, image: '', tags: '' }]);
          }
          resetForm();
        };
        const resetForm = () => {
          setUrl('');
          setTitle('');
          setSelectedDishType('');
          setSelectedMealType('');
          setCookbook('');
          setIsNewCookbook(false);
          setPrepTime('');
          setCookTime('');
          setDirections('');
          setRating(0);
          setNotes('');
          setTemperatureValue('');
          setTemperatureScale('F');
          setIngredients([]);
          setNewImagePreview('');
          setEditingIndex(null);
          setModalTab('General');
          setBaseServings('');
          setDesiredServings('');
          setShowModal(false);
        };
        const handleDeleteRecipe = (recipeToDelete) => {
          setRecipes(recipes.filter(r => r.id !== recipeToDelete.id));
          setMealPlan(prev => {
            const newPlan = { ...prev };
            Object.keys(newPlan).forEach(day => {
              Object.keys(newPlan[day]).forEach(type => {
                if (newPlan[day][type] === recipeToDelete.id) {
                  newPlan[day][type] = '';
                }
              });
            });
            return newPlan;
          });
        };
        const handleEditRecipe = (index, recipeData) => {
          setEditingIndex(index);
          setTitle(recipeData.title || '');
          setSelectedDishType(recipeData.dishType || '');
          setSelectedMealType(recipeData.mealType || '');
          setCookbook(recipeData.cookbook || '');
          setIsNewCookbook(false);
          setPrepTime(recipeData.prepTime || '');
          setCookTime(recipeData.cookTime || '');
          setDirections(recipeData.directions || '');
          setRating(recipeData.rating || 0);
          setNotes(recipeData.notes || '');
          setTemperatureValue(recipeData.temperature?.value || '');
          setTemperatureScale(recipeData.temperature?.scale || 'F');
          setIngredients(recipeData.ingredients || []);
          setNewImagePreview(recipeData.image || '');
          setBaseServings(recipeData.baseServings || '');
          setShowModal(true);
        };
        const handleCreateCookbook = (newName) => {
          if (newName && !cookbooks.find(cb => cb.title === newName)) {
            setCookbooks(prev => [...prev, { title: newName, image: '', tags: '' }]);
          }
          setShowCreateCookbookModal(false);
        };
        const updateCookbookData = (index, updatedCookbook) => {
          const oldTitle = cookbooks[index].title;
          const updatedCookbooks = [...cookbooks];
          updatedCookbooks[index] = updatedCookbook;
          setCookbooks(updatedCookbooks);
          const updatedRecipes = recipes.map(r =>
            r.cookbook === oldTitle ? { ...r, cookbook: updatedCookbook.title } : r
          );
          setRecipes(updatedRecipes);
          setEditCookbook(null);
        };
        const handlePrintCookbook = (cookbookObj) => {
          const cbRecipes = recipes.filter(r => r.cookbook === cookbookObj.title);
          const printWindow = window.open('', '', 'height=800,width=1200');
          printWindow.document.write('<html><head><title>Print Cookbook</title>');
          printWindow.document.write(
            '<style>body { font-family: Arial, sans-serif; } .card { border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; } img { max-width: 100%; height: auto; } @media print { body { margin: 20px; } }</style>'
          );
          printWindow.document.write('</head><body>');
          printWindow.document.write("<h1 class='text-white'>Cookbook: " + cookbookObj.title + '</h1>');
          cbRecipes.forEach(recipe => {
            printWindow.document.write('<div class="card printable">');
            printWindow.document.write("<h2 class='text-white'>" + (recipe.title || 'Untitled Recipe') + '</h2>');
            if (recipe.image) {
              printWindow.document.write('<img src="' + recipe.image + '" alt="Recipe Image" class="mb-4" />');
            }
            printWindow.document.write("<p class='text-white'><strong>Dish Type:</strong> " + (recipe.dishType || 'N/A') + '</p>');
            printWindow.document.write("<p class='text-white'><strong>Meal Type:</strong> " + (recipe.mealType || 'N/A') + '</p>');
            printWindow.document.write("<p class='text-white'><strong>Prep Time:</strong> " + (recipe.prepTime || 'N/A') + '</p>');
            printWindow.document.write("<p class='text-white'><strong>Cook Time:</strong> " + (recipe.cookTime || 'N/A') + '</p>');
            printWindow.document.write('</div>');
          });
          printWindow.document.write('</body></html>');
          printWindow.document.close();
          printWindow.focus();
          printWindow.print();
        };
        const handleDeleteCookbook = (cookbookObj, index) => {
          if (confirm(`Are you sure you want to delete the cookbook "${cookbookObj.title}"?`)) {
            const updatedCookbooks = cookbooks.filter((_, i) => i !== index);
            setCookbooks(updatedCookbooks);
            const updatedRecipes = recipes.map(r =>
              r.cookbook === cookbookObj.title ? { ...r, cookbook: '' } : r
            );
            setRecipes(updatedRecipes);
          }
        };
        const printAllRecipes = () => {
          const filteredRecipesList = recipes.filter(
            r =>
              r.title.toLowerCase().includes(searchQuery.toLowerCase()) &&
              (filterDish === '' || r.dishType === filterDish) &&
              (filterMeal === '' || r.mealType === filterMeal)
          );
          const printWindow = window.open('', '', 'height=800,width=1200');
          printWindow.document.write('<html><head><title>Print All Recipes</title>');
          printWindow.document.write(
            '<style>body { font-family: Arial, sans-serif; } .card { border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; } img { max-width: 100%; height: auto; } @media print { body { margin: 20px; } }</style>'
          );
          printWindow.document.write('</head><body>');
          filteredRecipesList.forEach(recipe => {
            printWindow.document.write('<div class="card printable">');
            printWindow.document.write("<h1 class='text-white'>" + (recipe.title || 'Untitled Recipe') + '</h1>');
            if (recipe.image) {
              printWindow.document.write('<img src="' + recipe.image + '" alt="Recipe Image" class="mb-4" />');
            }
            printWindow.document.write("<p class='text-white'><strong>Dish Type:</strong> " + (recipe.dishType || 'N/A') + '</p>');
            printWindow.document.write("<p class='text-white'><strong>Meal Type:</strong> " + (recipe.mealType || 'N/A') + '</p>');
            printWindow.document.write("<p class='text-white'><strong>Cookbook:</strong> " + (recipe.cookbook || 'N/A') + '</p>');
            printWindow.document.write("<p class='text-white'><strong>Prep Time:</strong> " + (recipe.prepTime || 'N/A') + '</p>');
            printWindow.document.write("<p class='text-white'><strong>Cook Time:</strong> " + (recipe.cookTime || 'N/A') + '</p>');
            if (recipe.temperature && recipe.temperature.value) {
              printWindow.document.write("<p class='text-white'><strong>Temp:</strong> " + recipe.temperature.value + '°' + recipe.temperature.scale + '</p>');
            }
            printWindow.document.write("<p class='text-white'><strong>Rating:</strong> " +
              '★'.repeat(recipe.rating) + '☆'.repeat(5 - recipe.rating) + '</p>');
            if (recipe.ingredients && recipe.ingredients.length > 0) {
              printWindow.document.write("<h3 class='text-white'>Ingredients</h3><ul>");
              recipe.ingredients.forEach(ing => {
                printWindow.document.write("<li class='text-white'>" +
                  (ing.quantity ? ing.quantity + ' ' : '') +
                  (ing.unit ? ing.unit + ' ' : '') +
                  ing.name + '</li>');
              });
              printWindow.document.write('</ul>');
            }
            if (recipe.directions) {
              printWindow.document.write("<h3 class='text-white'>Directions</h3><p class='text-white'>" +
                recipe.directions.replace(/\n/g, '<br>') + '</p>');
            }
            printWindow.document.write('</div>');
          });
          printWindow.document.write('</body></html>');
          printWindow.document.close();
          printWindow.focus();
          printWindow.print();
        };
        const getShoppingList = () => {
          const agg = {};
          Object.keys(mealPlan).forEach(day => {
            const dayPlan = mealPlan[day];
            Object.keys(dayPlan).forEach(mealType => {
              const recipeId = dayPlan[mealType];
              if (recipeId !== '') {
                const theRecipe = recipes.find(r => r.id === recipeId);
                if (theRecipe && theRecipe.ingredients) {
                  theRecipe.ingredients.forEach(ing => {
                    const key = ing.name.toLowerCase() + '_' + ing.unit;
                    const qty = parseFloat(ing.quantity);
                    if (!agg[key]) {
                      agg[key] = { name: ing.name, unit: ing.unit, quantity: isNaN(qty) ? ing.quantity : qty };
                    } else {
                      if (!isNaN(qty)) agg[key].quantity += qty;
                    }
                  });
                }
              }
            });
          });
          return Object.values(agg);
        };
        const printShoppingList = () => {
          const shoppingItems = getShoppingList();
          const printWindow = window.open('', '', 'height=600,width=800');
          printWindow.document.write('<html><head><title>Print Shopping List</title>');
          printWindow.document.write('<style>body { font-family: Arial, sans-serif; } .printable { margin: 20px; } ul { list-style: disc; padding-left: 20px; } </style>');
          printWindow.document.write('</head><body>');
          printWindow.document.write('<div class="printable"><h1>Shopping List</h1>');
          if (shoppingItems.length > 0) {
            printWindow.document.write('<ul>');
            shoppingItems.forEach(item => {
              printWindow.document.write('<li>' + item.quantity + ' ' + item.unit + ' ' + item.name + '</li>');
            });
            printWindow.document.write('</ul>');
          } else {
            printWindow.document.write('<p>No ingredients in the shopping list.</p>');
          }
          printWindow.document.write('</div></body></html>');
          printWindow.document.close();
          printWindow.focus();
          printWindow.print();
        };
        const downloadShoppingList = () => {
          const shoppingItems = getShoppingList();
          let content = 'Shopping List:\n\n';
          if (shoppingItems.length > 0) {
            shoppingItems.forEach(item => {
              content += `${item.quantity} ${item.unit} ${item.name}\n`;
            });
          } else {
            content += 'No ingredients in the shopping list.\n';
          }
          const blob = new Blob([content], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'shopping_list.txt';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        };
        const shareShoppingList = async () => {
          const shoppingItems = getShoppingList();
          let content = 'Shopping List:\n\n';
          if (shoppingItems.length > 0) {
            shoppingItems.forEach(item => {
              content += `${item.quantity} ${item.unit} ${item.name}\n`;
            });
          } else {
            content += 'No ingredients in the shopping list.\n';
          }
          if (navigator.share) {
            try {
              await navigator.share({ title: 'Shopping List', text: content });
            } catch (error) {
              console.error('Error sharing', error);
            }
          } else {
            try {
              await navigator.clipboard.writeText(content);
              alert('Shopping list copied to clipboard.');
            } catch (error) {
              console.error('Clipboard error', error);
              alert('Unable to share shopping list.');
            }
          }
        };

        // Render the Ingredients tab with CategorizedMasterIngredientsList
        const renderIngredientsTab = () => {
          return (
            <div id="main-content">
              <CategorizedMasterIngredientsList
                masterIngredients={masterIngredients}
                setMasterIngredients={setMasterIngredients}
                selectedIngredients={selectedIngredients}
                setSelectedIngredients={setSelectedIngredients}
                filterRecipes={filterRecipes}
              />

              {/* NEW: Display filtered recipes below */}
              <div className="mt-6">
                <h2 className="text-2xl font-bold text-white mb-4">Filtered Recipes</h2>
                {filteredRecipes.length > 0 ? (
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {filteredRecipes.map((r, index) => (
                      <RecipeCard
                        key={r.id}
                        index={index}
                        recipe={r}
                        onDeleteRecipe={handleDeleteRecipe}
                        onEditRecipe={handleEditRecipe}
                      />
                    ))}
                  </div>
                ) : (
                  <p className="text-white">
                    No recipes match the selected ingredients.
                  </p>
                )}
              </div>
            </div>
          );
        };

        return (
          <div className="min-h-screen flex flex-col" role="document">
            <header className="bg-gradient-to-r from-gray-700 to-gray-900 text-white flex items-center justify-between p-4 shadow-lg" role="banner">
              <div className="flex items-center">
                <h1 className="text-xl font-bold mr-8">Sunshine Kitchen</h1>
              </div>
              <div className="flex items-center space-x-4">
                <div className="relative">
                  <button onClick={() => setShowSearch(!showSearch)} className="p-2" aria-label="Search">
                    <span className="material-icons">search</span>
                  </button>
                  {showSearch && (
                    <input
                      type="text"
                      placeholder="Search recipes..."
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      className="absolute top-full left-0 mt-1 p-2 border rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"
                    />
                  )}
                </div>
                <div className="relative">
                  <button onClick={() => setDotsMenuOpen(!dotsMenuOpen)} className="p-2 focus:outline-none" aria-label="Apps">
                    <span className="material-icons">apps</span>
                  </button>
                  {dotsMenuOpen && (
                    <div className="absolute right-0 mt-2 w-48 bg-gray-800 border border-gray-700 rounded shadow-lg z-10">
                      <button
                        onClick={() => { setDotsMenuOpen(false); setShowImportModal(true); }}
                        className="block w-full text-left px-4 py-2 hover:bg-gray-700"
                      >
                        Import
                      </button>
                      <button
                        onClick={() => { setDotsMenuOpen(false); handleExportRecipes(); }}
                        className="block w-full text-left px-4 py-2 hover:bg-gray-700"
                      >
                        Export
                      </button>
                      <button
                        onClick={() => { setDotsMenuOpen(false); printAllRecipes(); }}
                        className="block w-full text-left px-4 py-2 hover:bg-gray-700"
                      >
                        Print
                      </button>
                    </div>
                  )}
                </div>
                <button onClick={() => setMobileNavOpen(!mobileNavOpen)} className="p-2" aria-label="Toggle navigation menu">
                  <span className="material-icons">menu</span>
                </button>
                <button onClick={() => setShowModal(true)} className="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded" aria-label="Add a new recipe">
                  <span className="text-xl">+</span>
                </button>
              </div>
            </header>
            {mobileNavOpen && (
              <nav className="bg-gradient-to-r from-gray-700 to-gray-900 text-white">
                <ul className="flex flex-col">
                  {['categories', 'recipes', 'cookbooks', 'mealTimes', 'mealPlan', 'shoppingList', 'ingredients'].map(tab => (
                    <li key={tab}>
                      <button
                        onClick={() => { setActiveTab(tab); setMobileNavOpen(false); setSelectedCookbook(null); setSelectedMealTime(null); }}
                        className="block w-full text-left px-4 py-2 border-b border-gray-600"
                      >
                        {tab.charAt(0).toUpperCase() + tab.slice(1)}
                      </button>
                    </li>
                  ))}
                </ul>
              </nav>
            )}
            <div className="flex-1 flex flex-col">
              <main className="p-4 md:p-8 flex-1 overflow-auto" id="main-content" tabIndex="0">
                {activeTab === 'recipes' ? (
                  <div>
                    <div className="flex space-x-4 mb-4">
                      <select
                        value={filterDish}
                        onChange={(e) => setFilterDish(e.target.value)}
                        className="p-2 border rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"
                      >
                        <option value="">All Dish Types</option>
                        {dishTypes.map((type, index) => (
                          <option key={index} value={type}>{type}</option>
                        ))}
                      </select>
                      <select
                        value={filterMeal}
                        onChange={(e) => setFilterMeal(e.target.value)}
                        className="p-2 border rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"
                      >
                        <option value="">All Meal Types</option>
                        {mealTypes.map((type, index) => (
                          <option key={index} value={type}>{type}</option>
                        ))}
                      </select>
                    </div>
                    {recipes.filter(
                      r =>
                        r.title.toLowerCase().includes(searchQuery.toLowerCase()) &&
                        (filterDish === '' || r.dishType === filterDish) &&
                        (filterMeal === '' || r.mealType === filterMeal)
                    ).length === 0 ? (
                      <p className="text-white">No recipes available.</p>
                    ) : (
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {recipes.filter(
                          r =>
                            r.title.toLowerCase().includes(searchQuery.toLowerCase()) &&
                            (filterDish === '' || r.dishType === filterDish) &&
                            (filterMeal === '' || r.mealType === filterMeal)
                        ).map((r, index) => (
                          <RecipeCard key={r.id} index={index} recipe={r} onDeleteRecipe={handleDeleteRecipe} onEditRecipe={handleEditRecipe} />
                        ))}
                      </div>
                    )}
                  </div>
                ) : activeTab === 'categories' ? (
                  <div id="main-content">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                      {dishTypes.map((cat, index) => {
                        const catRecipes = recipes.filter(r => r.dishType === cat);
                        const customImage = categoryImages[cat];
                        const image = customImage || catRecipes.find(r => r.image)?.image || '';
                        return (
                          <div key={index} className="border rounded-lg shadow bg-gray-800 text-white p-4 hover:shadow-xl transition-shadow duration-300">
                            <div className="relative w-full" style={{ paddingTop: '75%' }}>
                              {image ? (
                                <img src={image} alt={`${cat} category`} className="absolute top-0 left-0 w-full h-full object-cover rounded-t-lg" />
                              ) : (
                                <div className="absolute top-0 left-0 w-full h-full border-2 border-dashed border-gray-600 flex items-center justify-center text-white rounded-t-lg">
                                  <span>Add Image</span>
                                </div>
                              )}
                              <input
                                type="file"
                                accept="image/*"
                                className="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer"
                                onChange={(e) => {
                                  const file = e.target.files[0];
                                  if (file) {
                                    const reader = new FileReader();
                                    reader.onloadend = () => {
                                      setCategoryImages(prev => ({ ...prev, [cat]: reader.result }));
                                    };
                                    reader.readAsDataURL(file);
                                  }
                                }}
                                aria-label={`Upload an image for category ${cat}`}
                              />
                            </div>
                            <div className="mt-4">
                              <h3 className="text-xl font-bold text-white">{cat}</h3>
                              <p className="text-white">{catRecipes.length} recipes</p>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                ) : activeTab === 'cookbooks' ? (
                  selectedCookbook ? (
                    <div id="main-content">
                      <button
                        onClick={() => setSelectedCookbook(null)}
                        className="mb-4 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded"
                      >
                        &larr; Back to Cookbooks
                      </button>
                      <h2 className="text-2xl font-bold mb-4 text-white">{selectedCookbook.title}</h2>
                      {recipes.filter(r => r.cookbook === selectedCookbook.title).length === 0 ? (
                        <p className="text-white">No recipes in this cookbook.</p>
                      ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          {recipes.filter(r => r.cookbook === selectedCookbook.title).map((r, index) => (
                            <RecipeCard key={r.id} index={index} recipe={r} onDeleteRecipe={handleDeleteRecipe} onEditRecipe={handleEditRecipe} />
                          ))}
                        </div>
                      )}
                    </div>
                  ) : (
                    <div id="main-content">
                      <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold text-white">Cookbooks</h2>
                        <button
                          onClick={() => setShowCreateCookbookModal(true)}
                          className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded"
                        >
                          Create Cookbook
                        </button>
                      </div>
                      {cookbooks.length === 0 ? (
                        <p className="text-white">No cookbooks available.</p>
                      ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          {cookbooks.map((cb, index) => {
                            const cbRecipes = recipes.filter(r => r.cookbook === cb.title);
                            const image = cb.image || cbRecipes.find(r => r.image)?.image || '';
                            return (
                              <div
                                key={index}
                                onClick={() => setSelectedCookbook(cb)}
                                className="cursor-pointer border rounded-lg shadow bg-gray-800 text-white p-4 hover:shadow-xl transition-shadow duration-300"
                              >
                                <div className="relative w-full" style={{ paddingTop: '75%' }}>
                                  {image ? (
                                    <img src={image} alt={`${cb.title} cookbook`} className="absolute top-0 left-0 w-full h-full object-cover rounded-t-lg" />
                                  ) : (
                                    <div className="absolute top-0 left-0 w-full h-full border-2 border-dashed border-gray-600 flex items-center justify-center text-white rounded-t-lg">
                                      <span>Add Image</span>
                                    </div>
                                  )}
                                </div>
                                <div className="mt-4">
                                  <h3 className="text-xl font-bold text-white">{cb.title}</h3>
                                  <p className="text-white">{cbRecipes.length} recipes</p>
                                  <div className="mt-4 flex justify-between">
                                    <button
                                      onClick={(e) => { e.stopPropagation(); setEditCookbook({ index, data: cb }); }}
                                      className="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-sm"
                                    >
                                      Edit
                                    </button>
                                    <button
                                      onClick={(e) => { e.stopPropagation(); handlePrintCookbook(cb); }}
                                      className="bg-indigo-500 hover:bg-indigo-600 text-white px-2 py-1 rounded text-sm"
                                    >
                                      Print Cookbook
                                    </button>
                                    <button
                                      onClick={(e) => { e.stopPropagation(); handleDeleteCookbook(cb, index); }}
                                      className="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm"
                                    >
                                      Delete
                                    </button>
                                  </div>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </div>
                  )
                ) : activeTab === 'mealTimes' ? (
                  selectedMealTime ? (
                    <div id="main-content">
                      <button
                        onClick={() => setSelectedMealTime(null)}
                        className="mb-4 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded"
                      >
                        &larr; Back to Meal Times
                      </button>
                      <h2 className="text-2xl font-bold mb-4 text-white">{selectedMealTime}</h2>
                      {recipes.filter(r => r.mealType === selectedMealTime).length === 0 ? (
                        <p className="text-white">No recipes for this meal time.</p>
                      ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          {recipes.filter(r => r.mealType === selectedMealTime).map((r, index) => (
                            <RecipeCard key={r.id} index={index} recipe={r} onDeleteRecipe={handleDeleteRecipe} onEditRecipe={handleEditRecipe} />
                          ))}
                        </div>
                      )}
                    </div>
                  ) : (
                    <div id="main-content">
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {mealTypes.map((meal, index) => {
                          const mealRecipes = recipes.filter(r => r.mealType === meal);
                          const image = mealRecipes.find(r => r.image)?.image || '';
                          return (
                            <div
                              key={index}
                              onClick={() => setSelectedMealTime(meal)}
                              className="cursor-pointer border rounded-lg shadow bg-gray-800 text-white p-4 hover:shadow-xl transition-shadow duration-300"
                            >
                              <div className="relative w-full" style={{ paddingTop: '75%' }}>
                                {image ? (
                                  <img src={image} alt={`${meal} meal time`} className="absolute top-0 left-0 w-full h-full object-cover rounded-t-lg" />
                                ) : (
                                  <div className="absolute top-0 left-0 w-full h-full border-2 border-dashed border-gray-600 flex items-center justify-center text-white rounded-t-lg">
                                    <span>Add Image</span>
                                  </div>
                                )}
                                <input
                                  type="file"
                                  accept="image/*"
                                  className="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer"
                                  onChange={(e) => {
                                    const file = e.target.files[0];
                                    if (file) {
                                      const reader = new FileReader();
                                      reader.onloadend = () => { };
                                      reader.readAsDataURL(file);
                                    }
                                  }}
                                  aria-label={`Upload an image for meal time ${meal}`}
                                />
                              </div>
                              <div className="mt-4">
                                <h3 className="text-xl font-bold text-white">{meal}</h3>
                                <p className="text-white">{mealRecipes.length} recipes</p>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )
                ) : activeTab === 'mealPlan' ? (
                  <div id="main-content">
                    <h2 className="text-2xl font-bold mb-4 text-white">Meal Plan Calendar</h2>
                    <MealPlanCalendar
                      mealPlan={mealPlan}
                      recipes={recipes}
                      mealTypes={mealTypes}
                      updateMealPlan={(day, mealType, newValue) => {
                        setMealPlan(prev => {
                          const newPlan = { ...prev };
                          newPlan[day] = { ...newPlan[day], [mealType]: newValue };
                          return newPlan;
                        });
                      }}
                    />
                  </div>
                ) : activeTab === 'shoppingList' ? (
                  <div id="main-content">
                    <h2 className="text-2xl font-bold mb-4 text-white">Shopping List</h2>
                    <div className="mb-4 flex space-x-4">
                      <button onClick={printShoppingList} className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                        Print
                      </button>
                      <button onClick={downloadShoppingList} className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                        Download
                      </button>
                      <button onClick={shareShoppingList} className="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded">
                        Share
                      </button>
                    </div>
                    {getShoppingList().length === 0 ? (
                      <p className="text-white">No ingredients in the shopping list.</p>
                    ) : (
                      <ul className="list-disc list-inside">
                        {getShoppingList().map((item, index) => (
                          <li key={index} className="text-white">
                            {item.quantity} {item.unit} {item.name}
                          </li>
                        ))}
                      </ul>
                    )}
                  </div>
                ) : activeTab === 'ingredients' ? (
                  renderIngredientsTab()
                ) : null}
              </main>
            </div>
            <footer className="bg-gray-800 text-center text-white p-4 border-t" role="contentinfo">
              &copy; {new Date().getFullYear()} Sunshine Kitchen
            </footer>
            {showModal && (
              <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" role="dialog" aria-modal="true" aria-label="Add or Edit Recipe Modal">
                <div className="modal-container bg-gray-800 text-white rounded-lg shadow-lg overflow-auto">
                  <div className="flex justify-between items-center p-4 border-b border-gray-700">
                    <h2 className="text-2xl font-bold text-white">{editingIndex !== null ? 'Edit Recipe' : 'Add a Recipe'}</h2>
                    <button onClick={() => resetForm()} className="text-white hover:text-gray-300 text-2xl" aria-label="Close add recipe modal">
                      &times;
                    </button>
                  </div>
                  <div className="flex border-b border-gray-700">
                    {['General', 'Ingredients', 'Directions', 'Grocery', 'Notes'].map(tab => (
                      <button
                        key={tab}
                        onClick={() => setModalTab(tab)}
                        className={`flex-1 p-2 text-center ${modalTab === tab ? 'border-b-2 border-teal-500 font-bold' : ''} text-white`}
                      >
                        {tab === 'Notes' ? 'Notes & Rating' : tab}
                      </button>
                    ))}
                  </div>
                  <div className="p-4">
                    {modalTab === 'General' && (
                      <div className="space-y-4">
                        {fetchMethod === 'url' && (
                          <div>
                            <input
                              id="recipe-url"
                              type="text"
                              placeholder="Enter recipe URL (type 'test' to simulate)"
                              value={url}
                              onChange={(e) => setUrl(e.target.value)}
                              className="w-full p-2 border rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"
                            />
                            <button
                              onClick={handleFetchRecipe}
                              disabled={loading}
                              className="w-full bg-teal-500 hover:bg-teal-600 text-white p-2 rounded mt-2"
                            >
                              {loading ? 'Fetching...' : 'Fetch Recipe'}
                            </button>
                          </div>
                        )}
                        <div>
                          <label htmlFor="recipe-title" className="block mb-1 text-white">Title</label>
                          <input
                            id="recipe-title"
                            type="text"
                            placeholder="Recipe Title"
                            value={title}
                            onChange={(e) => setTitle(e.target.value)}
                            className="w-full p-2 border rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"
                          />
                        </div>
                        <div className="flex space-x-4">
                          <div className="w-1/2">
                            <label htmlFor="dish-type" className="block mb-1 text-white">Dish Type</label>
                            <select
                              id="dish-type"
                              value={selectedDishType}
                              onChange={(e) => setSelectedDishType(e.target.value)}
                              className="w-full p-2 border rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"
                            >
                              <option value="">Select Dish Type</option>
                              {dishTypes.map(type => (
                                <option key={type} value={type}>{type}</option>
                              ))}
                            </select>
                          </div>
                          <div className="w-1/2">
                            <label htmlFor="meal-type" className="block mb-1 text-white">Meal Type</label>
                            <select
                              id="meal-type"
                              value={selectedMealType}
                              onChange={(e) => setSelectedMealType(e.target.value)}
                              className="w-full p-2 border rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"
                            >
                              <option value="">Select Meal Type</option>
                              {mealTypes.map(type => (
                                <option key={type} value={type}>{type}</option>
                              ))}
                            </select>
                          </div>
                        </div>
                        <div>
                          <label htmlFor="cookbook-name" className="block mb-1 text-white">Cookbook</label>
                          <select
                            id="cookbook-name"
                            value={isNewCookbook ? 'new' : cookbook || ''}
                            onChange={(e) => {
                              if (e.target.value === 'new') {
                                setIsNewCookbook(true);
                                setCookbook('');
                              } else {
                                setIsNewCookbook(false);
                                setCookbook(e.target.value);
                              }
                            }}
                            className="w-full p-2 border rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"
                          >
                            <option value="">None</option>
                            {cookbooks.map((cb, i) => (
                              <option key={i} value={cb.title}>{cb.title}</option>
                            ))}
                            <option value="new">Create New Cookbook</option>
                          </select>
                          {isNewCookbook && (
                            <div className="mt-2">
                              <input
                                type="text"
                                placeholder="Enter new cookbook name"
                                value={cookbook}
                                onChange={(e) => setCookbook(e.target.value)}
                                className="w-full p-2 border rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"
                              />
                            </div>
                          )}
                        </div>
                        <div className="flex space-x-4">
                          <div className="w-1/2">
                            <label htmlFor="prep-time" className="block mb-1 text-white">Prep Time</label>
                            <input
                              id="prep-time"
                              type="text"
                              placeholder="e.g. 10 minutes"
                              value={prepTime}
                              onChange={(e) => setPrepTime(e.target.value)}
                              className="w-full p-2 border rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"
                            />
                          </div>
                          <div className="w-1/2">
                            <label htmlFor="cook-time" className="block mb-1 text-white">Cook Time</label>
                            <input
                              id="cook-time"
                              type="text"
                              placeholder="e.g. 30 minutes"
                              value={cookTime}
                              onChange={(e) => setCookTime(e.target.value)}
                              className="w-full p-2 border rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"
                            />
                          </div>
                        </div>
                        <div className="flex space-x-4">
                          <div className="w-1/2">
                            <label htmlFor="base-servings" className="block mb-1 text-white">Base Servings</label>
                            <input
                              id="base-servings"
                              type="number"
                              placeholder="Base Servings"
                              value={baseServings}
                              onChange={(e) => setBaseServings(e.target.value)}
                              className="w-full p-2 border rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"
                            />
                          </div>
                          <div className="w-1/2">
                            <label htmlFor="desired-servings" className="block mb-1 text-white">Desired Servings</label>
                            <input
                              id="desired-servings"
                              type="number"
                              placeholder="Desired Servings"
                              value={desiredServings}
                              onChange={(e) => setDesiredServings(e.target.value)}
                              className="w-full p-2 border rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"
                            />
                          </div>
                        </div>
                        <button onClick={handleScaleRecipe} className="bg-teal-500 hover:bg-teal-600 text-black px-4 py-2 rounded mt-2">
                          Scale Recipe
                        </button>
                        <div>
                          <label htmlFor="recipe-image" className="block text-white mb-2">Recipe Image</label>
                          <div className="relative w-full" style={{ paddingTop: '60%' }}>
                            {newImagePreview ? (
                              <img src={newImagePreview} alt="Recipe" className="absolute top-0 left-0 w-full h-full object-cover rounded" />
                            ) : (
                              <div className="absolute top-0 left-0 w-full h-full border-2 border-dashed border-gray-600 flex items-center justify-center text-white rounded">
                                <span>Click to add image</span>
                              </div>
                            )}
                            <input
                              id="recipe-image"
                              type="file"
                              accept="image/*"
                              ref={recipeImageInputRef}
                              className="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer"
                              onChange={handleImageChange}
                              aria-label="Upload recipe image"
                            />
                          </div>
                          {newImagePreview && (
                            <button onClick={() => recipeImageInputRef.current.click()} className="mt-2 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">
                              Change Image
                            </button>
                          )}
                        </div>
                      </div>
                    )}
                    {modalTab === 'Ingredients' && (
                      <div>
                        <p className="mb-2 text-white font-semibold">Ingredients</p>
                        {ingredients.map((ingredient, index) => (
                          <IngredientRow
                            key={index}
                            ingredient={ingredient}
                            index={index}
                            handleIngredientChange={handleIngredientChange}
                            removeIngredientRow={removeIngredientRow}
                            masterIngredients={masterIngredients}
                          />
                        ))}
                        <button
                          type="button"
                          onClick={addIngredientRow}
                          className="bg-teal-500 hover:bg-teal-600 text-black px-4 py-2 rounded mt-2"
                        >
                          + Add Ingredient
                        </button>
                      </div>
                    )}
                    {modalTab === 'Directions' && (
                      <div>
                        <label htmlFor="directions" className="block mb-1 text-white">Directions</label>
                        <textarea
                          id="directions"
                          rows="6"
                          placeholder="Step-by-step directions"
                          value={directions}
                          onChange={(e) => setDirections(e.target.value)}
                          className="w-full p-2 border rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"
                        />
                      </div>
                    )}
                    {modalTab === 'Grocery' && (
                      <div>
                        <p className="mb-2 text-white font-semibold">Grocery List</p>
                        {ingredients.length === 0 ? (
                          <p className="text-white">No ingredients added.</p>
                        ) : (
                          <ul className="list-disc list-inside">
                            {ingredients.map((ing, index) => (
                              <li key={index} className="text-white">
                                {(ing.quantity ? ing.quantity + ' ' : '') +
                                  (ing.unit ? ing.unit + ' ' : '') +
                                  ing.name}
                              </li>
                            ))}
                          </ul>
                        )}
                      </div>
                    )}
                    {modalTab === 'Notes' && (
                      <div className="space-y-4">
                        <div>
                          <label htmlFor="rating" className="block mb-1 text-white">Rating</label>
                          <StarRating rating={rating} setRating={setRating} />
                        </div>
                        <div>
                          <label htmlFor="notes" className="block mb-1 text-white">Notes</label>
                          <textarea
                            id="notes"
                            rows="4"
                            placeholder="Additional notes"
                            value={notes}
                            onChange={(e) => setNotes(e.target.value)}
                            className="w-full p-2 border rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"
                          />
                        </div>
                      </div>
                    )}
                  </div>
                  <div className="p-4 border-t border-gray-700 flex justify-end">
                    <button onClick={handleAddRecipe} className="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded transition-colors duration-300">
                      {editingIndex !== null ? 'Update Recipe' : 'Save Recipe'}
                    </button>
                  </div>
                </div>
              </div>
            )}
            {showCreateCookbookModal && (
              <CreateCookbookModal onCreate={handleCreateCookbook} onClose={() => setShowCreateCookbookModal(false)} />
            )}
            {editCookbook && (
              <EditCookbookModal
                cookbook={editCookbook.data}
                onUpdate={(updatedData) => updateCookbookData(editCookbook.index, updatedData)}
                onClose={() => setEditCookbook(null)}
              />
            )}
            {showImportModal && (
              <ImportModal onClose={() => setShowImportModal(false)} onImport={handleImportRecipes} />
            )}
          </div>
        );
      }

      function ImportModal({ onClose, onImport }) {
        const [file, setFile] = useState(null);
        const [error, setError] = useState(null);

        const handleFileChange = (e) => {
          setFile(e.target.files[0]);
          setError(null);
        };

        const handleImport = () => {
          if (!file) {
            setError("Please select a file.");
            return;
          }
          const reader = new FileReader();
          reader.onload = (e) => {
            const content = e.target.result;
            let importedRecipes = [];
            try {
              if (file.name.endsWith('.json')) {
                importedRecipes = JSON.parse(content);
              } else if (file.name.endsWith('.csv')) {
                importedRecipes = Papa.parse(content, { header: true }).data;
              } else if (file.name.endsWith('.xlsx')) {
                const workbook = XLSX.read(content, { type: 'binary' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                importedRecipes = XLSX.utils.sheet_to_json(worksheet);
              } else {
                setError("Unsupported file type.");
                return;
              }
              onImport(importedRecipes);
              onClose();
            } catch (err) {
              console.error(err);
              setError("Failed to import recipes.");
            }
          };
          if (file.name.endsWith('.xlsx')) {
            reader.readAsBinaryString(file);
          } else {
            reader.readAsText(file);
          }
        };

        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
            <div className="bg-gray-800 p-4 rounded text-white">
              <h2 className="text-xl mb-4">Import Recipes</h2>
              <input type="file" accept=".json,.csv,.xlsx" onChange={handleFileChange} className="mb-4" />
              {error && <p className="text-red-500 mb-2">{error}</p>}
              <div className="flex justify-end mt-4">
                <button onClick={onClose} className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded mr-2">Cancel</button>
                <button onClick={handleImport} className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">Import</button>
              </div>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<RecipeSaver />);
    </script>
  </body>
</html>
